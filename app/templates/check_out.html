<!-- CASI IDENTICA A check_in.html 
Cambian textos y la ruta para registrar check out -->

{% extends "base.html" %}
{% block content %}

<div class="container">
    <h2>Registrar Check-Out</h2>

    <p><b>Cliente:</b> {{ client.name }}</p>
    <p><b>Direcci√≥n:</b> {{ client.address }}</p>

    <div id="map" style="height: 450px; width: 100%; margin-top: 20px;"></div>

    <br>
    <button id="btnCheckOut">Registrar Check-Out</button>
    <a href="/mis-visitas">Cancelar</a>
</div>

<script>
let map, technicianMarker, clientMarker, lat, lng;

function initMap() {
    const clientPos = { lat: parseFloat("{{ client.latitude }}"), lng: parseFloat("{{ client.longitude }}") };

    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 16,
        center: clientPos
    });

    clientMarker = new google.maps.Marker({
        position: clientPos,
        map: map,
        label: "C"
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            lat = pos.coords.latitude;
            lng = pos.coords.longitude;

            technicianMarker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                label: "T",
                icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
            });

            const bounds = new google.maps.LatLngBounds();
            bounds.extend(clientPos);
            bounds.extend({ lat, lng });
            map.fitBounds(bounds);
        });
    }
}

document.getElementById("btnCheckOut").onclick = function () {
    fetch("/registrar-checkout/{{ visit_id }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ latitude: lat, longitude: lng })
    }).then(() => {
        window.location.href = "/mis-visitas";
    });
};
</script>

<script async src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap"></script>

{% endblock %}
